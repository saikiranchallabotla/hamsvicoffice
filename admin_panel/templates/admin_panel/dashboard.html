{% extends "admin_panel/base.html" %}

{% block title %}Dashboard{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        margin-bottom: 1.5rem;
    }
    
    .page-header h4 {
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }
    
    .page-header .timestamp {
        font-size: 0.8rem;
        color: var(--text-muted);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .dashboard-card {
        background: var(--card-bg);
        border-radius: 14px;
        border: 1px solid var(--border-color);
        box-shadow: var(--card-shadow);
        overflow: hidden;
        transition: all 0.25s ease;
    }
    
    .dashboard-card:hover {
        box-shadow: var(--card-shadow-hover);
    }
    
    .dashboard-card .card-header {
        background: #fafbfc;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .dashboard-card .card-header h5 {
        margin: 0;
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .dashboard-card .card-header h5 i {
        color: var(--admin-accent);
    }
    
    .section-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .section-title i {
        color: var(--admin-accent);
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h4>Dashboard</h4>
        <span class="timestamp">Last updated: {{ now|date:"d M Y, h:i A" }}</span>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="stat-value">{{ stats.total_users }}</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-icon" style="background: #dbeafe; color: #2563eb;">
                <i class="bi bi-people-fill"></i>
            </div>
        </div>
        <div class="stat-change positive">
            <i class="bi bi-arrow-up"></i> {{ stats.new_users_week }} this week
        </div>
    </div>
    
    <div class="stat-card">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="stat-value">{{ stats.active_subscriptions }}</div>
                <div class="stat-label">Active Subscriptions</div>
            </div>
            <div class="stat-icon" style="background: #dcfce7; color: #16a34a;">
                <i class="bi bi-check-circle-fill"></i>
            </div>
        </div>
        <div class="stat-change" style="color: var(--warning);">
            <i class="bi bi-hourglass-split"></i> {{ stats.trial_subscriptions }} trials
        </div>
    </div>
    
    <div class="stat-card">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="stat-value">₹{{ stats.month_revenue|floatformat:0 }}</div>
                <div class="stat-label">Revenue (30 days)</div>
            </div>
            <div class="stat-icon" style="background: #f3e8ff; color: #9333ea;">
                <i class="bi bi-wallet2"></i>
            </div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <div class="stat-value">{{ stats.open_tickets }}</div>
                <div class="stat-label">Open Tickets</div>
            </div>
            <div class="stat-icon" style="background: #fef3c7; color: #d97706;">
                <i class="bi bi-headset"></i>
            </div>
        </div>
        {% if stats.open_tickets > 0 %}
        <a href="{% url 'admin_ticket_list' %}?status=open" class="stat-change text-decoration-none" style="color: var(--admin-accent);">
            View all <i class="bi bi-arrow-right"></i>
        </a>
        {% endif %}
    </div>
</div>

<!-- Main Content Grid -->
<div class="row g-4">
    <!-- Recent Users -->
    <div class="col-lg-6">
        <div class="dashboard-card">
            <div class="card-header">
                <h5><i class="bi bi-people-fill"></i> Recent Users</h5>
                <a href="{% url 'admin_user_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body p-0">
                <table class="table admin-table mb-0">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Joined</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in recent_users %}
                        <tr>
                            <td>
                                <a href="{% url 'admin_user_detail' u.id %}">
                                    {{ u.get_full_name|default:u.username }}
                                </a>
                            </td>
                            <td class="text-muted">{{ u.email }}</td>
                            <td class="text-muted">{{ u.date_joined|date:"d M" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-muted text-center py-3">No recent users</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Recent Payments -->
    <div class="col-lg-6">
        <div class="dashboard-card">
            <div class="card-header">
                <h5><i class="bi bi-wallet2"></i> Recent Payments</h5>
                <a href="{% url 'admin_payment_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body p-0">
                <table class="table admin-table mb-0">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in recent_payments %}
                        <tr>
                            <td>
                                <a href="{% url 'admin_user_detail' p.user.id %}" class="fw-semibold text-decoration-none">
                                    {{ p.user.username }}
                                </a>
                            </td>
                            <td class="fw-semibold">₹{{ p.total_amount|floatformat:0 }}</td>
                            <td class="text-muted">{{ p.created_at|date:"d M" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-muted text-center py-4">No recent payments</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Recent Tickets Section -->
<div class="mt-4">
    <div class="dashboard-card">
        <div class="card-header">
            <h5><i class="bi bi-headset"></i> Recent Support Tickets</h5>
            <a href="{% url 'admin_ticket_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table admin-table mb-0">
                    <thead>
                        <tr>
                            <th>Ticket</th>
                            <th>User</th>
                            <th>Subject</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for t in recent_tickets %}
                        <tr>
                            <td>
                                <a href="{% url 'admin_ticket_detail' t.id %}" class="fw-semibold text-decoration-none">#{{ t.ticket_number }}</a>
                            </td>
                            <td>{{ t.user.username }}</td>
                            <td class="text-truncate-2" style="max-width: 200px;">{{ t.subject|truncatewords:6 }}</td>
                            <td>
                                <span class="badge status-{{ t.status }}">{{ t.get_status_display }}</span>
                            </td>
                            <td>
                                <span class="badge priority-{{ t.priority }}">{{ t.get_priority_display }}</span>
                            </td>
                            <td class="text-muted">{{ t.created_at|date:"d M" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-muted text-center py-4">No recent tickets</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Section -->
<div class="mt-4">
    <h6 class="section-title"><i class="bi bi-lightning-charge-fill"></i> Quick Actions</h6>
    <div class="quick-actions-grid">
        <a href="{% url 'admin_analytics' %}" class="quick-action-btn">
            <i class="bi bi-bar-chart-fill"></i>
            <span>Analytics</span>
        </a>
        <a href="{% url 'admin_data_management' %}" class="quick-action-btn">
            <i class="bi bi-database-fill"></i>
            <span>Backend Data</span>
        </a>
        <a href="{% url 'admin_module_list' %}" class="quick-action-btn">
            <i class="bi bi-box-seam-fill"></i>
            <span>Modules</span>
        </a>
        <a href="{% url 'admin_announcement_list' %}" class="quick-action-btn">
            <i class="bi bi-megaphone-fill"></i>
            <span>Announcements</span>
        </a>
        <a href="{% url 'admin_faq_list' %}" class="quick-action-btn">
            <i class="bi bi-patch-question-fill"></i>
            <span>FAQs</span>
        </a>
        <a href="/admin/" class="quick-action-btn">
            <i class="bi bi-gear-fill"></i>
            <span>Django Admin</span>
        </a>
    </div>
</div>
{% endblock %}
