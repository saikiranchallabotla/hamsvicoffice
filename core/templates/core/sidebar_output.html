<div style="margin-top: 20px; border:1px solid #ddd; padding:12px; border-radius:6px; background:#fff;">

    <h3 style="margin-top:0;">Selected Items (Live)</h3>

    {% if fetched_details %}
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
            <tr>
                <th style="border-bottom:1px solid #ccc; padding:4px; text-align:center;">Sl</th>
                <th style="border-bottom:1px solid #ccc; padding:4px; text-align:left;">Item</th>
                <th style="border-bottom:1px solid #ccc; padding:4px; text-align:right;">Rate</th>
                <th style="border-bottom:1px solid #ccc; padding:4px; text-align:right;">Qty</th>
                <th style="border-bottom:1px solid #ccc; padding:4px; text-align:right;">Amount</th>
            </tr>
            </thead>
            <tbody>
            {% for row in fetched_details %}
                <tr>
                    <td style="padding:4px; text-align:center;">{{ row.slno }}</td>
                    <td style="padding:4px; text-align:left;">{{ row.name }}</td>
                    <td style="padding:4px; text-align:right;"
                        data-rate="{{ row.rate|default:'' }}">
                        {{ row.rate_display }}
                    </td>
                    <td style="padding:4px; text-align:right;">
                        <input type="number"
                               step="0.01"
                               class="est-qty"
                               style="width:70px; text-align:right;"
                               data-row="{{ forloop.counter0 }}">
                    </td>
                    <td style="padding:4px; text-align:right;">
                        <span class="est-amount" data-row="{{ forloop.counter0 }}">0.00</span>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
            <tfoot>
            <tr>
                <td colspan="4" style="padding:4px; text-align:right; font-weight:bold;">Total</td>
                <td style="padding:4px; text-align:right; font-weight:bold;">
                    <span id="est-total">0.00</span>
                </td>
            </tr>
            </tfoot>
        </table>

        <!-- Actions -->
        <div style="margin-top:10px;">
            <a href="{% url 'download_output' category %}"
               style="display:inline-block; margin-bottom:6px; background:#17a2b8; color:#fff;
                      padding:6px 10px; border-radius:4px; text-decoration:none;">
                ‚¨á Download Output
            </a>

            <a href="{% url 'clear_output' category %}"
               style="display:inline-block; margin-bottom:6px; margin-left:6px; background:#dc3545; color:#fff;
                      padding:6px 10px; border-radius:4px; text-decoration:none;">
                ‚ùå Clear
            </a>
        </div>

        <!-- Save Project -->
        <form action="{% url 'save_project' category %}" method="POST" style="margin-top:8px;">
            {% csrf_token %}
            <input type="text"
                   name="project_name"
                   placeholder="Enter Project Name"
                   style="width:100%; padding:6px; border:1px solid #aaa; border-radius:4px; margin-bottom:6px;">
            <button type="submit"
                    style="width:100%; background:#007bff; color:#fff; padding:8px; border:none; border-radius:4px;">
                üíæ Save Project
            </button>
        </form>
    {% else %}
        <p style="margin:0;">No items selected.</p>
    {% endif %}
</div>

<script>
(function() {
    function recalc() {
        var inputs = document.querySelectorAll('.est-qty');
        var total = 0;

        inputs.forEach(function(input) {
            var key = input.getAttribute('data-row');
            var tr = input.closest('tr');
            if (!tr) return;

            var rateCell = tr.querySelector('td[data-rate]');
            var rate = parseFloat(rateCell.getAttribute('data-rate')) || 0;
            var qty = parseFloat(input.value) || 0;
            var amount = rate * qty;

            var amtSpan = tr.querySelector('.est-amount[data-row="' + key + '"]');
            if (amtSpan) {
                amtSpan.textContent = amount.toFixed(2);
            }
            total += amount;
        });

        var totalSpan = document.getElementById('est-total');
        if (totalSpan) {
            totalSpan.textContent = total.toFixed(2);
        }
    }

    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('est-qty')) {
            recalc();
        }
    });
})();
</script>
