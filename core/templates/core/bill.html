{% extends "core/base_modern.html" %}
{% load static %}

{% block title %}Bill Generator{% endblock %}

{% block page_title %}
<i class="bi bi-receipt me-2"></i>Bill Generator
{% endblock %}

{% block content %}
<style>
    /* Common Card */
    .common-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .common-header {
        background: linear-gradient(135deg, #805ad5 0%, #d53f8c 100%);
        color: white;
        padding: 0.5rem 0.75rem;
    }

    .common-header h2 {
        margin: 0;
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .common-tagline {
        font-size: 0.68rem;
        margin-top: 0.15rem;
        opacity: 0.9;
    }

    .common-body {
        padding: 0.6rem 0.75rem;
    }
    
    .common-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1rem;
    }
    
    @media (max-width: 992px) {
        .common-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .common-left, .common-right {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .common-right {
        gap: 0.4rem;
    }

    /* Field Groups */
    .field-group {
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 0.5rem 0.6rem;
        margin-bottom: 0.5rem;
        background: #f7fafc;
    }

    .field-group-label {
        font-size: 0.72rem;
        font-weight: 600;
        color: #805ad5;
        margin-bottom: 0.35rem;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .field-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .field-row label {
        font-size: 0.68rem;
        color: #4a5568;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }

    .field-row input,
    .field-row select {
        padding: 0.3rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 4px;
        border: 1px solid #e2e8f0;
        min-width: 70px;
        background: white;
        transition: all 0.2s;
    }

    .field-row input:focus,
    .field-row select:focus {
        outline: none;
        border-color: #805ad5;
        box-shadow: 0 0 0 2px rgba(128, 90, 213, 0.1);
    }

    .note {
        font-size: 0.68rem;
        color: #718096;
        margin-top: 0.3rem;
    }

    /* Error Alert */
    .bill-error {
        background: #fff5f5;
        border: 1px solid #feb2b2;
        color: #c53030;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Bill Section Selector */
    .bill-section-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
    }
    
    .bill-option-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        font-size: 0.85rem;
        font-weight: 600;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        background: white;
        color: #4a5568;
        cursor: pointer;
        transition: all 0.25s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }
    
    .bill-option-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .bill-option-btn.option-estimate {
        border-color: #2d3748;
    }
    .bill-option-btn.option-estimate:hover,
    .bill-option-btn.option-estimate.active {
        background: #2d3748;
        color: white;
        border-color: #2d3748;
    }
    
    .bill-option-btn.option-workslip {
        border-color: #319795;
    }
    .bill-option-btn.option-workslip:hover,
    .bill-option-btn.option-workslip.active {
        background: #319795;
        color: white;
        border-color: #319795;
    }
    
    .bill-option-btn.option-first {
        border-color: #dd6b20;
    }
    .bill-option-btn.option-first:hover,
    .bill-option-btn.option-first.active {
        background: #dd6b20;
        color: white;
        border-color: #dd6b20;
    }
    
    .bill-option-btn.option-nth {
        border-color: #805ad5;
    }
    .bill-option-btn.option-nth:hover,
    .bill-option-btn.option-nth.active {
        background: #805ad5;
        color: white;
        border-color: #805ad5;
    }
    
    .bill-option-btn i {
        font-size: 1.1rem;
    }
    
    /* Sections Container */
    .sections-container {
        display: none;
    }
    
    .sections-container.active {
        display: block;
    }

    /* Section Cards */
    .section-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        overflow: hidden;
    }

    .section-header {
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .section-header.blue { background: #2d3748; color: white; }
    .section-header.teal { background: #319795; color: white; }
    .section-header.orange { background: #dd6b20; color: white; }
    .section-header.purple { background: #805ad5; color: white; }

    .section-badge {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.85rem;
    }

    .section-info h2 {
        margin: 0;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .section-tagline {
        font-size: 0.72rem;
        opacity: 0.9;
        margin-top: 0.15rem;
    }

    .section-body {
        padding: 1rem;
    }

    /* Upload Blocks */
    .upload-block {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        background: #f7fafc;
    }

    .upload-block:last-child {
        margin-bottom: 0;
    }

    .upload-block h3 {
        margin: 0 0 0.5rem 0;
        font-size: 0.82rem;
        color: #2d3748;
        font-weight: 600;
    }

    .upload-block label {
        font-size: 0.75rem;
        color: #4a5568;
        display: block;
        margin-bottom: 0.35rem;
    }

    .upload-block input[type="file"] {
        font-size: 0.75rem;
        margin-bottom: 0.5rem;
    }

    /* Buttons */
    .btn-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }

    .bill-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .bill-btn-primary {
        background: #805ad5;
        color: white;
    }

    .bill-btn-primary:hover {
        background: #6b46c1;
    }

    .bill-btn-secondary {
        background: #e2e8f0;
        color: #4a5568;
    }

    .bill-btn-secondary:hover {
        background: #cbd5e0;
    }

    .bill-btn-teal {
        background: #319795;
        color: white;
    }

    .bill-btn-teal:hover {
        background: #2c7a7b;
    }

    .bill-btn-orange {
        background: #dd6b20;
        color: white;
    }

    .bill-btn-orange:hover {
        background: #c05621;
    }

    .bill-btn:disabled {
        background: #cbd5e0;
        cursor: not-allowed;
    }
    
    /* Template-required buttons - disabled state */
    .template-btn-disabled {
        opacity: 0.5;
        position: relative;
        pointer-events: auto !important;
    }
    
    .template-btn-disabled::after {
        content: '\F62A'; /* Bootstrap icon lock */
        font-family: 'bootstrap-icons';
        position: absolute;
        top: -6px;
        right: -6px;
        background: #e53e3e;
        color: white;
        font-size: 0.55rem;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Template required popup modal */
    .template-popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .template-popup-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    
    .template-popup {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 420px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        transform: scale(0.8);
        transition: transform 0.3s ease;
    }
    
    .template-popup-overlay.show .template-popup {
        transform: scale(1);
    }
    
    .template-popup-icon {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
    }
    
    .template-popup-icon i {
        font-size: 2rem;
        color: #b45309;
    }
    
    .template-popup h3 {
        margin: 0 0 0.75rem;
        font-size: 1.25rem;
        color: #1a202c;
    }
    
    .template-popup p {
        color: #718096;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .template-popup-btn {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
    }
    
    .template-popup-btn-primary {
        background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
        color: white;
    }
    
    .template-popup-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(128, 90, 213, 0.4);
    }
    
    .template-popup-close {
        background: #e2e8f0;
        color: #4a5568;
        margin-left: 0.5rem;
    }
    
    .template-popup-close:hover {
        background: #cbd5e0;
    }
    
    .template-upload-hint {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        padding: 0.75rem;
        margin-top: 1rem;
        font-size: 0.8rem;
        color: #0369a1;
    }
    
    .template-upload-hint i {
        font-size: 1.2rem;
    }
</style>

{% if error %}
<div class="bill-error">
    <i class="bi bi-exclamation-circle"></i>
    {{ error }}
</div>
{% endif %}

<!-- COMMON DETAILS -->
<div class="common-card">
    <div class="common-header">
        <h2><i class="bi bi-gear-fill"></i> Common MB / Date Details & Bill Type</h2>
        <div class="common-tagline">
            These details are used for ALL Bills and ALL Documents (LS, Covering Letter, Movement Slip).
        </div>
    </div>
    <div class="common-body">
        <div class="common-grid">
            <!-- Left Column: MB Details, Dates, Bill Type -->
            <div class="common-left">
                <div class="field-group">
                    <div class="field-group-label"><i class="bi bi-book"></i> Measurement Book Details</div>
                    <div style="font-size: 0.6rem; color: #059669; margin-bottom: 0.35rem; background: #ecfdf5; padding: 0.25rem 0.5rem; border-radius: 4px;">
                        <i class="bi bi-magic"></i> <strong>Auto-detect:</strong> If your bill file has M.B.No details, they'll be picked up automatically. Fill these only if the file doesn't have them or you want to override.
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <div style="background: #f0f9ff; padding: 0.6rem 0.75rem; border-radius: 6px; border: 1px solid #bae6fd;">
                            <div style="font-size: 0.68rem; color: #0369a1; font-weight: 600; margin-bottom: 0.35rem;">
                                <i class="bi bi-journal-text me-1"></i>Measurement Book
                            </div>
                            <div class="field-row" style="gap: 0.5rem;">
                                <label style="flex: 2;">M.B. No. <input type="text" id="common_mb_measure_no" style="width:100%;" /></label>
                                <label style="flex: 1;">From Pg. <input type="text" id="common_mb_measure_p_from" style="width:100%" /></label>
                                <label style="flex: 1;">To Pg. <input type="text" id="common_mb_measure_p_to" style="width:100%" /></label>
                            </div>
                        </div>
                        <div style="background: #fef3c7; padding: 0.6rem 0.75rem; border-radius: 6px; border: 1px solid #fcd34d;">
                            <div style="font-size: 0.68rem; color: #b45309; font-weight: 600; margin-bottom: 0.35rem;">
                                <i class="bi bi-journal-bookmark me-1"></i>Abstract Book
                            </div>
                            <div class="field-row" style="gap: 0.5rem;">
                                <label style="flex: 2;">Abs. M.B. No. <input type="text" id="common_mb_abstract_no" style="width:100%;" /></label>
                                <label style="flex: 1;">From Pg. <input type="text" id="common_mb_abstract_p_from" style="width:100%" /></label>
                                <label style="flex: 1;">To Pg. <input type="text" id="common_mb_abstract_p_to" style="width:100%" /></label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="field-group">
                    <div class="field-group-label"><i class="bi bi-calendar3"></i> Important Dates</div>
                    <div class="field-row" style="gap: 0.6rem;">
                        <label style="flex: 1;">
                            <span style="display: flex; align-items: center; gap: 0.25rem;">
                                <i class="bi bi-calendar-event" style="color: #059669;"></i> Date of Indication
                            </span>
                            <input type="date" id="common_doi" style="width:100%" />
                        </label>
                        <label style="flex: 1;">
                            <span style="display: flex; align-items: center; gap: 0.25rem;">
                                <i class="bi bi-calendar-check" style="color: #0284c7;"></i> Date of Completion
                            </span>
                            <input type="date" id="common_doc" style="width:100%" />
                        </label>
                        <label style="flex: 1;">
                            <span style="display: flex; align-items: center; gap: 0.25rem;">
                                <i class="bi bi-calendar-week" style="color: #7c3aed;"></i> D.O.M.R.
                            </span>
                            <input type="date" id="common_domr" style="width:100%" />
                        </label>
                        <label style="flex: 1;">
                            <span style="display: flex; align-items: center; gap: 0.25rem;">
                                <i class="bi bi-calendar2-check" style="color: #dc2626;"></i> D.O.B.R.
                            </span>
                            <input type="date" id="common_dobr" style="width:100%" />
                        </label>
                    </div>
                </div>

                <div class="field-group">
                    <div class="field-group-label"><i class="bi bi-hash"></i> Bill Configuration</div>
                    <div class="field-row" style="gap: 0.6rem; align-items: flex-end;">
                        <label style="width: 80px;">
                            Nth Bill No.
                            <input type="number" id="common_nth_number" min="2" step="1" style="width:100%" placeholder="2, 3..." />
                        </label>
                        <label style="flex: 1;">
                            Bill Type
                            <select id="common_action" style="width:100%">
                                <option value="">-- Select Bill Type --</option>
                                <option value="estimate_first_part">First & Part Bill</option>
                                <option value="estimate_first_final">First & Final Bill</option>
                                <option value="firstpart_nth_part">Nth & Part (from 1st Part)</option>
                                <option value="firstpart_2nd_final">2nd & Final (from 1st Part)</option>
                                <option value="nth_nth_part">Nth & Part (from Nth)</option>
                                <option value="nth_nth_final">Nth & Final (from Nth)</option>
                            </select>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Template Uploads -->
            <div class="common-right">
                <!-- Covering Letter Template -->
                <div class="field-group" style="padding: 0.5rem 0.6rem; {% if covering_letter_template %}background: #f0fff4; border: 2px solid #48bb78;{% else %}background: #fff5f5; border: 2px solid #fc8181;{% endif %} border-radius: 8px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 0.3rem;">
                        <div class="field-group-label" style="{% if covering_letter_template %}color: #276749;{% else %}color: #c53030;{% endif %} font-size: 0.72rem; margin-bottom: 0; font-weight: 600;">
                            <i class="bi bi-file-earmark-text"></i> Covering Letter
                        </div>
                        {% if covering_letter_template %}
                        <span style="background: #48bb78; color: white; font-size: 0.58rem; padding: 0.1rem 0.4rem; border-radius: 10px; font-weight: 600; letter-spacing: 0.3px;">
                            <i class="bi bi-check-circle-fill"></i> UPLOADED
                        </span>
                        {% else %}
                        <span style="background: #fc8181; color: white; font-size: 0.58rem; padding: 0.1rem 0.4rem; border-radius: 10px; font-weight: 600; letter-spacing: 0.3px;">
                            <i class="bi bi-x-circle-fill"></i> NOT UPLOADED
                        </span>
                        {% endif %}
                    </div>
                    {% if covering_letter_template %}
                    <div style="background: #e6ffed; border-radius: 5px; padding: 0.25rem 0.4rem; margin-bottom: 0.3rem; font-size: 0.62rem; color: #276749;">
                        <div style="display:flex; align-items:center; gap:0.3rem;">
                            <i class="bi bi-file-earmark-word" style="font-size: 0.75rem;"></i>
                            <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-weight:500;">
                                {{ covering_letter_template.file_name|default:covering_letter_template.name|truncatechars:25 }}
                            </span>
                            <a href="{% url 'template_download' covering_letter_template.id %}" class="bill-btn bill-btn-secondary" style="padding:0.1rem 0.25rem; font-size:0.55rem; text-decoration:none;" title="Download">
                                <i class="bi bi-download"></i>
                            </a>
                        </div>
                        <div style="font-size: 0.55rem; color: #68d391; margin-top: 0.15rem;">
                            <i class="bi bi-clock"></i> Uploaded: {{ covering_letter_template.updated_at|date:"d M Y, h:i A" }}
                        </div>
                    </div>
                    <details style="font-size: 0.62rem;">
                        <summary style="cursor: pointer; color: #718096; user-select: none;">
                            <i class="bi bi-arrow-repeat"></i> Replace template
                        </summary>
                        <form action="{% url 'template_upload' %}?next=bill" method="post" enctype="multipart/form-data" style="display:flex; gap:0.3rem; align-items:center; margin-top:0.25rem;">
                            {% csrf_token %}
                            <input type="hidden" name="template_type" value="covering_letter">
                            <input type="hidden" name="name" value="Covering Letter">
                            <input type="hidden" name="next" value="bill">
                            <input type="file" name="file" accept=".docx,.doc" required style="font-size:0.6rem; flex:1; max-width: 140px;">
                            <button type="submit" class="bill-btn bill-btn-primary" style="padding:0.15rem 0.35rem; font-size:0.6rem;">
                                <i class="bi bi-arrow-repeat"></i> Replace
                            </button>
                        </form>
                    </details>
                    {% else %}
                    <div style="background: #fff0f0; border-radius: 5px; padding: 0.3rem 0.4rem; margin-bottom: 0.15rem; font-size: 0.6rem; color: #c53030;">
                        <i class="bi bi-info-circle"></i> Upload your Word (.docx) template to generate covering letters.
                    </div>
                    <form action="{% url 'template_upload' %}?next=bill" method="post" enctype="multipart/form-data" style="display:flex; gap:0.3rem; align-items:center;">
                        {% csrf_token %}
                        <input type="hidden" name="template_type" value="covering_letter">
                        <input type="hidden" name="name" value="Covering Letter">
                        <input type="hidden" name="next" value="bill">
                        <input type="file" name="file" accept=".docx,.doc" required style="font-size:0.6rem; flex:1; max-width: 140px;">
                        <button type="submit" class="bill-btn bill-btn-primary" style="padding:0.15rem 0.35rem; font-size:0.6rem;">
                            <i class="bi bi-upload"></i> Upload
                        </button>
                    </form>
                    {% endif %}
                </div>
                
                <!-- Movement Slip Template -->
                <div class="field-group" style="padding: 0.5rem 0.6rem; margin-top: 0.4rem; {% if movement_slip_template %}background: #fffff0; border: 2px solid #ecc94b;{% else %}background: #fff5f5; border: 2px solid #fc8181;{% endif %} border-radius: 8px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 0.3rem;">
                        <div class="field-group-label" style="{% if movement_slip_template %}color: #975a16;{% else %}color: #c53030;{% endif %} font-size: 0.72rem; margin-bottom: 0; font-weight: 600;">
                            <i class="bi bi-file-earmark-text"></i> Movement Slip
                        </div>
                        {% if movement_slip_template %}
                        <span style="background: #ecc94b; color: #744210; font-size: 0.58rem; padding: 0.1rem 0.4rem; border-radius: 10px; font-weight: 600; letter-spacing: 0.3px;">
                            <i class="bi bi-check-circle-fill"></i> UPLOADED
                        </span>
                        {% else %}
                        <span style="background: #fc8181; color: white; font-size: 0.58rem; padding: 0.1rem 0.4rem; border-radius: 10px; font-weight: 600; letter-spacing: 0.3px;">
                            <i class="bi bi-x-circle-fill"></i> NOT UPLOADED
                        </span>
                        {% endif %}
                    </div>
                    {% if movement_slip_template %}
                    <div style="background: #fefcbf; border-radius: 5px; padding: 0.25rem 0.4rem; margin-bottom: 0.3rem; font-size: 0.62rem; color: #975a16;">
                        <div style="display:flex; align-items:center; gap:0.3rem;">
                            <i class="bi bi-file-earmark-word" style="font-size: 0.75rem;"></i>
                            <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-weight:500;">
                                {{ movement_slip_template.file_name|default:movement_slip_template.name|truncatechars:25 }}
                            </span>
                            <a href="{% url 'template_download' movement_slip_template.id %}" class="bill-btn bill-btn-secondary" style="padding:0.1rem 0.25rem; font-size:0.55rem; text-decoration:none;" title="Download">
                                <i class="bi bi-download"></i>
                            </a>
                        </div>
                        <div style="font-size: 0.55rem; color: #b7791f; margin-top: 0.15rem;">
                            <i class="bi bi-clock"></i> Uploaded: {{ movement_slip_template.updated_at|date:"d M Y, h:i A" }}
                        </div>
                    </div>
                    <details style="font-size: 0.62rem;">
                        <summary style="cursor: pointer; color: #718096; user-select: none;">
                            <i class="bi bi-arrow-repeat"></i> Replace template
                        </summary>
                        <form action="{% url 'template_upload' %}?next=bill" method="post" enctype="multipart/form-data" style="display:flex; gap:0.3rem; align-items:center; margin-top:0.25rem;">
                            {% csrf_token %}
                            <input type="hidden" name="template_type" value="movement_slip">
                            <input type="hidden" name="name" value="Movement Slip">
                            <input type="hidden" name="next" value="bill">
                            <input type="file" name="file" accept=".docx,.doc" required style="font-size:0.6rem; flex:1; max-width: 140px;">
                            <button type="submit" class="bill-btn bill-btn-primary" style="padding:0.15rem 0.35rem; font-size:0.6rem;">
                                <i class="bi bi-arrow-repeat"></i> Replace
                            </button>
                        </form>
                    </details>
                    {% else %}
                    <div style="background: #fff0f0; border-radius: 5px; padding: 0.3rem 0.4rem; margin-bottom: 0.15rem; font-size: 0.6rem; color: #c53030;">
                        <i class="bi bi-info-circle"></i> Upload your Word (.docx) template to generate movement slips.
                    </div>
                    <form action="{% url 'template_upload' %}?next=bill" method="post" enctype="multipart/form-data" style="display:flex; gap:0.3rem; align-items:center;">
                        {% csrf_token %}
                        <input type="hidden" name="template_type" value="movement_slip">
                        <input type="hidden" name="name" value="Movement Slip">
                        <input type="hidden" name="next" value="bill">
                        <input type="file" name="file" accept=".docx,.doc" required style="font-size:0.6rem; flex:1; max-width: 140px;">
                        <button type="submit" class="bill-btn bill-btn-primary" style="padding:0.15rem 0.35rem; font-size:0.6rem;">
                            <i class="bi bi-upload"></i> Upload
                        </button>
                    </form>
                    {% endif %}
                </div>
                
                <p class="note" style="margin-top:0.2rem; font-size: 0.58rem; color: #718096;">
                    <i class="bi bi-shield-check"></i> Templates are saved permanently â€” they persist across updates & redeployments.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- BILL SECTION SELECTOR -->
<div style="background: white; border-radius: 10px; padding: 0.75rem 1rem; margin-bottom: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.06);">
    <div style="font-size: 0.75rem; font-weight: 600; color: #718096; margin-bottom: 0.6rem;">
        <i class="bi bi-hand-index-thumb me-1"></i> Select Bill Type to Generate:
    </div>
    <div class="bill-section-selector" style="gap: 0.5rem;">
        <button type="button" class="bill-option-btn option-estimate" onclick="showBillSection('estimate')" style="padding: 0.6rem 1rem; font-size: 0.8rem;">
            <i class="bi bi-file-earmark-spreadsheet"></i> Bill from Estimate
        </button>
        <button type="button" class="bill-option-btn option-workslip" onclick="showBillSection('workslip')" style="padding: 0.6rem 1rem; font-size: 0.8rem;">
            <i class="bi bi-clipboard-data"></i> Bill from WorkSlip
        </button>
        <button type="button" class="bill-option-btn option-first" onclick="showBillSection('first')" style="padding: 0.6rem 1rem; font-size: 0.8rem;">
            <i class="bi bi-arrow-right-circle"></i> Second & Part/Final from First & Part Bill
        </button>
        <button type="button" class="bill-option-btn option-nth" onclick="showBillSection('nth')" style="padding: 0.6rem 1rem; font-size: 0.8rem;">
            <i class="bi bi-arrow-repeat"></i> Nth & Part/Final from Nth & Part Bill
        </button>
    </div>
</div>

<!-- SECTION 1: Bill from Estimate -->
<div class="sections-container" id="section-estimate">

    <div class="section-card">
        <div class="section-header blue">
            <div class="section-badge">1</div>
            <div class="section-info">
                <h2>Bill from Estimate</h2>
                <div class="section-tagline">Generate CC First & Part / First & Final from Estimate.</div>
            </div>
        </div>
        <div class="section-body">
            <form method="post" enctype="multipart/form-data" class="bill-form">
                {% csrf_token %}
                <!-- hidden common fields -->
                <input type="hidden" name="mb_measure_no">
                <input type="hidden" name="mb_measure_p_from">
                <input type="hidden" name="mb_measure_p_to">
                <input type="hidden" name="mb_abstract_no">
                <input type="hidden" name="mb_abstract_p_from">
                <input type="hidden" name="mb_abstract_p_to">
                <input type="hidden" name="doi">
                <input type="hidden" name="doc">
                <input type="hidden" name="domr">
                <input type="hidden" name="dobr">
                <input type="hidden" name="nth_number">
                <input type="hidden" name="action" />

                <div class="upload-block">
                    <h3><i class="bi bi-file-earmark-spreadsheet me-1"></i>Upload Estimate Excel</h3>
                    <label>
                        Select Estimate file:
                        <input type="file" name="bill_file" accept=".xlsx,.xls" required>
                    </label>
                    <p class="note">
                        Estimate format: A: Sl.No, B: Quantity, C: Unit, D: Item Description, E: Rate, H: Amount.
                    </p>
                    <div class="btn-row">
                        <button type="submit" name="action" value="estimate_first_part" class="bill-btn bill-btn-primary">
                            <i class="bi bi-file-earmark-plus"></i> CC First & Part
                        </button>
                        <button type="submit" name="action" value="estimate_first_final" class="bill-btn bill-btn-secondary">
                            <i class="bi bi-file-earmark-check"></i> CC First & Final
                        </button>
                    </div>
                </div>

                <div class="upload-block">
                    <h3><i class="bi bi-file-text me-1"></i>Documents from Estimate</h3>
                    <p class="note">Generate LS Form / Covering Letter / Movement Slip with common MB details.</p>
                    <div class="btn-row">
                        <button type="submit" formaction="{% url 'bill_document' %}" name="doc_kind" value="ls_part" class="bill-btn bill-btn-teal">
                            L.S. (Part)
                        </button>
                        <button type="submit" formaction="{% url 'bill_document' %}" name="doc_kind" value="ls_final" class="bill-btn bill-btn-secondary">
                            L.S. (Final)
                        </button>
                        <button type="button" class="bill-btn bill-btn-secondary template-doc-btn {% if not covering_letter_template %}template-btn-disabled{% endif %}" data-doc-type="covering" data-template-available="{% if covering_letter_template %}true{% else %}false{% endif %}" onclick="handleTemplateDocClick(this, 'covering', 'Covering Letter')">
                            Covering
                        </button>
                        <button type="button" class="bill-btn bill-btn-secondary template-doc-btn {% if not movement_slip_template %}template-btn-disabled{% endif %}" data-doc-type="movement" data-template-available="{% if movement_slip_template %}true{% else %}false{% endif %}" onclick="handleTemplateDocClick(this, 'movement', 'Movement Slip')">
                            Movement
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

</div>

<!-- SECTION 2: Bill from WorkSlip -->
<div class="sections-container" id="section-workslip">
    <div class="section-card">
        <div class="section-header teal">
            <div class="section-badge">2</div>
            <div class="section-info">
                <h2>Bill from WorkSlip</h2>
                <div class="section-tagline">Use executed quantities & T.P from WorkSlip.</div>
            </div>
        </div>
        <div class="section-body">
            <form method="post" enctype="multipart/form-data" class="bill-form">
                {% csrf_token %}
                <input type="hidden" name="mb_measure_no">
                <input type="hidden" name="mb_measure_p_from">
                <input type="hidden" name="mb_measure_p_to">
                <input type="hidden" name="mb_abstract_no">
                <input type="hidden" name="mb_abstract_p_from">
                <input type="hidden" name="mb_abstract_p_to">
                <input type="hidden" name="doi">
                <input type="hidden" name="doc">
                <input type="hidden" name="domr">
                <input type="hidden" name="dobr">
                <input type="hidden" name="nth_number">
                <input type="hidden" name="action" />

                <div class="upload-block">
                    <h3><i class="bi bi-file-earmark-spreadsheet me-1"></i>Upload WorkSlip Excel</h3>
                    <label>
                        Select WorkSlip file:
                        <input type="file" name="bill_file" accept=".xlsx,.xls" required>
                    </label>
                    <p class="note">
                        WorkSlip: B: Description, C: Unit, G: Qty(Exec), H: Rate(Exec), I: Amount(Exec).
                    </p>
                    <div class="btn-row">
                        <button type="submit" name="action" value="workslip_first_part" class="bill-btn bill-btn-teal">
                            <i class="bi bi-file-earmark-plus"></i> CC First & Part
                        </button>
                        <button type="submit" name="action" value="workslip_first_final" class="bill-btn bill-btn-secondary">
                            <i class="bi bi-file-earmark-check"></i> CC First & Final
                        </button>
                    </div>
                </div>

                <div class="upload-block">
                    <h3><i class="bi bi-file-text me-1"></i>Documents from WorkSlip</h3>
                    <p class="note">Generate LS Form, Covering Letter & Movement Slip.</p>
                    <div class="btn-row">
                        <button type="submit" formaction="{% url 'bill_document' %}" name="doc_kind" value="ls_part" class="bill-btn bill-btn-primary">
                            L.S. (Part)
                        </button>
                        <button type="submit" formaction="{% url 'bill_document' %}" name="doc_kind" value="ls_final" class="bill-btn bill-btn-secondary">
                            L.S. (Final)
                        </button>
                        <button type="button" class="bill-btn bill-btn-secondary template-doc-btn {% if not covering_letter_template %}template-btn-disabled{% endif %}" data-doc-type="covering" data-template-available="{% if covering_letter_template %}true{% else %}false{% endif %}" onclick="handleTemplateDocClick(this, 'covering', 'Covering Letter')">
                            Covering
                        </button>
                        <button type="button" class="bill-btn bill-btn-secondary template-doc-btn {% if not movement_slip_template %}template-btn-disabled{% endif %}" data-doc-type="movement" data-template-available="{% if movement_slip_template %}true{% else %}false{% endif %}" onclick="handleTemplateDocClick(this, 'movement', 'Movement Slip')">
                            Movement
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

</div>

<!-- SECTION 3: Nth & Part / 2nd & Final from First Bill -->
<div class="sections-container" id="section-first">
    <div class="section-card">
        <div class="section-header orange">
            <div class="section-badge">3</div>
            <div class="section-info">
                <h2>Nth / 2nd & Final from First Bill</h2>
                <div class="section-tagline">Upload First & Part / First & Final to generate Nth Bill.</div>
            </div>
        </div>
        <div class="section-body">
            <form method="post" enctype="multipart/form-data" class="bill-form">
                {% csrf_token %}
                <input type="hidden" name="mb_measure_no">
                <input type="hidden" name="mb_measure_p_from">
                <input type="hidden" name="mb_measure_p_to">
                <input type="hidden" name="mb_abstract_no">
                <input type="hidden" name="mb_abstract_p_from">
                <input type="hidden" name="mb_abstract_p_to">
                <input type="hidden" name="doi">
                <input type="hidden" name="doc">
                <input type="hidden" name="domr">
                <input type="hidden" name="dobr">
                <input type="hidden" name="nth_number">
                <input type="hidden" name="action" />

                <div class="upload-block">
                    <h3><i class="bi bi-file-earmark-arrow-up me-1"></i>Upload First & Part / First & Final Bill</h3>
                    <label>
                        Select Bill file:
                        <input type="file" name="bill_file" accept=".xlsx,.xls" required>
                    </label>
                    <p class="note">
                        Format: A: Sl.No, B: Quantity, C: Unit, D: Item, E: Rate, F: Per, G: Unit, H: Amount.
                    </p>
                    <div class="btn-row">
                        <button type="submit" name="action" value="firstpart_nth_part" class="bill-btn bill-btn-orange">
                            <i class="bi bi-file-earmark-plus"></i> CC Nth & Part
                        </button>
                        <button type="submit" name="action" value="firstpart_2nd_final" class="bill-btn bill-btn-secondary">
                            <i class="bi bi-file-earmark-check"></i> CC 2nd & Final
                        </button>
                    </div>
                </div>

                <div class="upload-block">
                    <h3><i class="bi bi-file-text me-1"></i>Documents from First Bill</h3>
                    <p class="note">Generate LS Form, Covering Letter & Movement Slip.</p>
                    <div class="btn-row">
                        <button type="submit" formaction="{% url 'bill_document' %}" name="doc_kind" value="ls_part" class="bill-btn bill-btn-primary">
                            L.S. (Part)
                        </button>
                        <button type="submit" formaction="{% url 'bill_document' %}" name="doc_kind" value="ls_final" class="bill-btn bill-btn-secondary">
                            L.S. (Final)
                        </button>
                        <button type="button" class="bill-btn bill-btn-secondary template-doc-btn {% if not covering_letter_template %}template-btn-disabled{% endif %}" data-doc-type="covering" data-template-available="{% if covering_letter_template %}true{% else %}false{% endif %}" onclick="handleTemplateDocClick(this, 'covering', 'Covering Letter')">
                            Covering
                        </button>
                        <button type="button" class="bill-btn bill-btn-secondary template-doc-btn {% if not movement_slip_template %}template-btn-disabled{% endif %}" data-doc-type="movement" data-template-available="{% if movement_slip_template %}true{% else %}false{% endif %}" onclick="handleTemplateDocClick(this, 'movement', 'Movement Slip')">
                            Movement
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

</div>

<!-- SECTION 4: Nth & Part / Nth & Final from Nth Bill -->
<div class="sections-container" id="section-nth">
    <div class="section-card">
        <div class="section-header purple">
            <div class="section-badge">4</div>
            <div class="section-info">
                <h2>Nth / Nth & Final from Nth Bill</h2>
                <div class="section-tagline">Chain from previous Nth & Part to next Nth Bill.</div>
            </div>
        </div>
        <div class="section-body">
            <form method="post" enctype="multipart/form-data" class="bill-form">
                {% csrf_token %}
                <input type="hidden" name="mb_measure_no">
                <input type="hidden" name="mb_measure_p_from">
                <input type="hidden" name="mb_measure_p_to">
                <input type="hidden" name="mb_abstract_no">
                <input type="hidden" name="mb_abstract_p_from">
                <input type="hidden" name="mb_abstract_p_to">
                <input type="hidden" name="doi">
                <input type="hidden" name="doc">
                <input type="hidden" name="domr">
                <input type="hidden" name="dobr">
                <input type="hidden" name="nth_number">
                <input type="hidden" name="action" />

                <div class="upload-block">
                    <h3><i class="bi bi-file-earmark-arrow-up me-1"></i>Upload Previous Nth & Part Bill</h3>
                    <label>
                        Select Nth & Part Bill file:
                        <input type="file" name="bill_file" accept=".xlsx,.xls" required>
                    </label>
                    <p class="note">
                        Format: C: Quantity Till Date, D: Unit, E: Rate per Unit, F: Total Value till date.
                    </p>
                    <div class="btn-row">
                        <button type="submit" name="action" value="nth_nth_part" class="bill-btn bill-btn-primary">
                            <i class="bi bi-file-earmark-plus"></i> CC Nth & Part
                        </button>
                        <button type="submit" name="action" value="nth_nth_final" class="bill-btn bill-btn-secondary">
                            <i class="bi bi-file-earmark-check"></i> CC Nth & Final
                        </button>
                    </div>
                </div>

                <div class="upload-block">
                    <h3><i class="bi bi-file-text me-1"></i>Documents from Nth Bill</h3>
                    <p class="note">Generate LS Form, Covering Letter & Movement Slip.</p>
                    <div class="btn-row">
                        <button type="submit" formaction="{% url 'bill_document' %}" name="doc_kind" value="ls_part" class="bill-btn bill-btn-teal">
                            L.S. (Part)
                        </button>
                        <button type="submit" formaction="{% url 'bill_document' %}" name="doc_kind" value="ls_final" class="bill-btn bill-btn-secondary">
                            L.S. (Final)
                        </button>
                        <button type="button" class="bill-btn bill-btn-secondary template-doc-btn {% if not covering_letter_template %}template-btn-disabled{% endif %}" data-doc-type="covering" data-template-available="{% if covering_letter_template %}true{% else %}false{% endif %}" onclick="handleTemplateDocClick(this, 'covering', 'Covering Letter')">
                            Covering
                        </button>
                        <button type="button" class="bill-btn bill-btn-secondary template-doc-btn {% if not movement_slip_template %}template-btn-disabled{% endif %}" data-doc-type="movement" data-template-available="{% if movement_slip_template %}true{% else %}false{% endif %}" onclick="handleTemplateDocClick(this, 'movement', 'Movement Slip')">
                            Movement
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

</div>

<!-- Template Required Popup Modal -->
<div id="templatePopup" class="template-popup-overlay" onclick="if(event.target===this)closeTemplatePopup()">
    <div class="template-popup">
        <div class="template-popup-icon">
            <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <h3 id="templatePopupTitle">Template Required</h3>
        <p id="templatePopupMessage">Please upload your template above to generate this document.</p>
        <div class="template-upload-hint">
            <i class="bi bi-arrow-up-circle"></i>
            <span>Scroll up and upload your <strong id="templatePopupType">template</strong> in the right panel above.</span>
        </div>
        <div style="margin-top: 1.5rem;">
            <button type="button" class="template-popup-btn template-popup-btn-primary" onclick="scrollToTemplateUpload()">
                <i class="bi bi-arrow-up me-1"></i> Go to Upload Section
            </button>
            <button type="button" class="template-popup-btn template-popup-close" onclick="closeTemplatePopup()">
                Close
            </button>
        </div>
    </div>
</div>

<script>
    // Template popup functions
    function handleTemplateDocClick(btn, docType, docName) {
        const templateAvailable = btn.getAttribute('data-template-available') === 'true';

        if (!templateAvailable) {
            // Show popup
            showTemplatePopup(docType, docName);
        } else {
            // Submit the form with the doc_kind
            const form = btn.closest('form');
            if (form) {
                // Create a hidden input for doc_kind and submit
                let hiddenInput = form.querySelector('input[name="doc_kind"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'doc_kind';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = docType;

                // Sync common fields and submit
                syncCommonToForm(form);
                form.action = "{% url 'bill_document' %}";
                form.submit();

                // Remove the hidden input after submission so it does not
                // interfere with subsequent native button clicks (L.S forms)
                // when the server returns a file download and the page stays.
                setTimeout(function() { hiddenInput.remove(); }, 100);
            }
        }
    }
    
    function showTemplatePopup(docType, docName) {
        const popup = document.getElementById('templatePopup');
        const title = document.getElementById('templatePopupTitle');
        const message = document.getElementById('templatePopupMessage');
        const typeSpan = document.getElementById('templatePopupType');
        
        title.textContent = docName + ' Template Required';
        message.textContent = 'You need to upload a ' + docName + ' template before generating this document.';
        typeSpan.textContent = docName;
        
        popup.classList.add('show');
    }
    
    function closeTemplatePopup() {
        const popup = document.getElementById('templatePopup');
        popup.classList.remove('show');
    }
    
    function scrollToTemplateUpload() {
        closeTemplatePopup();
        // Scroll to the template upload section (right column in common card)
        const templateSection = document.querySelector('.common-right');
        if (templateSection) {
            templateSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Highlight the template section briefly
            templateSection.style.transition = 'box-shadow 0.3s';
            templateSection.style.boxShadow = '0 0 0 3px #805ad5';
            setTimeout(() => {
                templateSection.style.boxShadow = '';
            }, 2000);
        }
    }
    
    // Bill section switching
    function showBillSection(sectionName) {
        // Hide all sections
        document.querySelectorAll('.sections-container').forEach(function(section) {
            section.classList.remove('active');
        });
        
        // Remove active from all buttons
        document.querySelectorAll('.bill-option-btn').forEach(function(btn) {
            btn.classList.remove('active');
        });
        
        // Show selected section
        const targetSection = document.getElementById('section-' + sectionName);
        if (targetSection) {
            targetSection.classList.add('active');
        }
        
        // Add active class to clicked button
        const activeBtn = document.querySelector('.bill-option-btn.option-' + sectionName);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
    }
    
    // Copy common inputs into each bill/doc form just before submit
    function syncCommonToForm(form) {
        const fields = [
            "mb_measure_no",
            "mb_measure_p_from",
            "mb_measure_p_to",
            "mb_abstract_no",
            "mb_abstract_p_from",
            "mb_abstract_p_to",
            "doi",
            "doc",
            "domr",
            "dobr",
            "nth_number"
        ];

        fields.forEach(function (name) {
            const common = document.getElementById("common_" + name);
            const target = form.querySelector('input[name="' + name + '"]');
            if (common && target) {
                target.value = common.value;
            }
        });

        // Copy common bill-type (for docs CC header only)
        const commonAction = document.getElementById("common_action");
        const hiddenAction = form.querySelector('input[name="action"][type="hidden"]');
        if (commonAction && hiddenAction) {
            hiddenAction.value = commonAction.value;
        }

        // Also add bill_type field for bill generation (not for docs)
        // Only add if not already present (for documents, we don't need this)
        if (!form.querySelector('input[name="bill_type"]')) {
            const billTypeInput = document.createElement('input');
            billTypeInput.type = 'hidden';
            billTypeInput.name = 'bill_type';
            billTypeInput.value = commonAction ? commonAction.value : '';
            form.appendChild(billTypeInput);
        }
    }

    /**
     * Handle form submission with job polling
     * @param {HTMLFormElement} form - The form being submitted
     * @param {HTMLButtonElement} submitButton - The button that was clicked
     */
    async function handleFormSubmitWithPolling(form, submitButton) {
        // Check if this is a document generation (uses bill_document endpoint)
        const isDocumentGeneration = submitButton.formaction && 
                                      submitButton.formaction.includes('bill_document');

        if (isDocumentGeneration) {
            // For async document generation
            syncCommonToForm(form);
            
            // Show loading modal
            const modal = JobPoller.createLoadingModal('processing');
            modal.show();

            // Submit form asynchronously
            const job = await JobPoller.submitFormAsync(form);
            
            if (!job) {
                modal.setMessage('Error: Failed to start job');
                setTimeout(() => modal.hide(), 2000);
                return;
            }

            // Poll for job completion
            JobPoller.pollUntilComplete(
                job.job_id,
                job.status_url,
                {
                    onProgress: (data) => {
                        const percent = data.progress || 0;
                        const step = data.current_step || 'Processing...';
                        modal.setProgress(percent);
                        modal.setMessage(step);
                    },
                    onComplete: (data) => {
                        modal.hide();
                        setTimeout(() => {
                            modal.remove();
                            JobPoller.showResultModal(data);
                        }, 500);
                    },
                    onError: (error) => {
                        modal.setMessage('Error: ' + error);
                        setTimeout(() => modal.hide(), 3000);
                    },
                },
                1000  // Poll every second
            );
        } else {
            // For regular bill generation, just sync and submit normally
            syncCommonToForm(form);
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        // Handle form submissions with job polling
        document.querySelectorAll("form.bill-form").forEach(function (form) {
            // Track which button was clicked
            let clickedButton = null;

            // Update clickedButton when any button in the form is clicked
            form.querySelectorAll('button[type="submit"]').forEach(function (btn) {
                btn.addEventListener('click', function (e) {
                    clickedButton = this;
                });
            });

            // Handle form submission
            form.addEventListener("submit", async function (e) {
                if (clickedButton && clickedButton.formaction && 
                    clickedButton.formaction.includes('bill_document')) {
                    // This is a document generation - handle with polling
                    e.preventDefault();
                    await handleFormSubmitWithPolling(form, clickedButton);
                } else {
                    // Regular submission
                    syncCommonToForm(form);
                }
            });
        });
    });
</script>

{% endblock %}
