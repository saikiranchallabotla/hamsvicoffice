{% extends 'accounts/auth_base.html' %}
{% load static %}

{% block title %}Verify OTP - SSR Estimation{% endblock %}

{% block auth_content %}
<div class="auth-card">
    <div class="auth-header">
        <div class="otp-icon">
            <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                <path d="M9 12l2 2 4-4"/>
            </svg>
        </div>
        <h1>Verify OTP</h1>
        <p>Enter the 6-digit code sent to<br><strong>{{ identifier }}</strong></p>
    </div>
    
    <form method="post" id="otpForm" class="auth-form">
        {% csrf_token %}
        
        <div class="otp-input-container">
            <input type="text" name="d1" maxlength="1" class="otp-digit" autofocus>
            <input type="text" name="d2" maxlength="1" class="otp-digit">
            <input type="text" name="d3" maxlength="1" class="otp-digit">
            <input type="text" name="d4" maxlength="1" class="otp-digit">
            <input type="text" name="d5" maxlength="1" class="otp-digit">
            <input type="text" name="d6" maxlength="1" class="otp-digit">
            <input type="hidden" name="otp" id="otpFull">
        </div>
        
        {% if attempts_remaining is not None %}
        <p class="attempts-warning">
            {{ attempts_remaining }} attempt{{ attempts_remaining|pluralize }} remaining
        </p>
        {% endif %}
        
        <button type="submit" class="btn btn-primary btn-block">
            <span class="btn-text">Verify</span>
            <span class="btn-loading" style="display:none;">
                <svg class="spinner" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="30 60"/>
                </svg>
            </span>
        </button>
    </form>
    
    <div class="resend-section">
        <p id="timerText">Resend OTP in <span id="countdown">60</span>s</p>
        <button type="button" id="resendBtn" class="btn btn-link" style="display:none;">
            Didn't receive code? <strong>Resend OTP</strong>
        </button>
    </div>
    
    <div class="auth-footer">
        <a href="{% url 'login' %}">‚Üê Back to Login</a>
    </div>
</div>

<style>
.otp-icon {
    margin-bottom: 1rem;
    color: var(--primary);
}

.otp-input-container {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin: 1.5rem 0;
}

.otp-digit {
    width: 48px;
    height: 56px;
    text-align: center;
    font-size: 1.5rem;
    font-weight: 600;
    border: 2px solid var(--border);
    border-radius: 8px;
    background: var(--bg-secondary);
    transition: all 0.2s;
}

.otp-digit:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.otp-digit.filled {
    border-color: var(--primary);
    background: rgba(37, 99, 235, 0.05);
}

.attempts-warning {
    color: var(--danger);
    font-size: 0.875rem;
    text-align: center;
    margin: 0.5rem 0;
}

.resend-section {
    text-align: center;
    margin-top: 1rem;
    color: var(--text-secondary);
}

.btn-link {
    background: none;
    border: none;
    color: var(--primary);
    cursor: pointer;
    font-size: 0.875rem;
}

.btn-link:hover {
    text-decoration: underline;
}
</style>

<script>
// OTP input handling
const otpInputs = document.querySelectorAll('.otp-digit');
const otpFull = document.getElementById('otpFull');

otpInputs.forEach((input, index) => {
    input.addEventListener('input', (e) => {
        const value = e.target.value.replace(/[^0-9]/g, '');
        e.target.value = value;
        
        if (value) {
            e.target.classList.add('filled');
            if (index < 5) {
                otpInputs[index + 1].focus();
            }
        } else {
            e.target.classList.remove('filled');
        }
        updateOtpFull();
    });
    
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
            otpInputs[index - 1].focus();
        }
    });
    
    input.addEventListener('paste', (e) => {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        const digits = paste.replace(/[^0-9]/g, '').slice(0, 6);
        
        digits.split('').forEach((digit, i) => {
            if (otpInputs[i]) {
                otpInputs[i].value = digit;
                otpInputs[i].classList.add('filled');
            }
        });
        
        if (digits.length > 0) {
            otpInputs[Math.min(digits.length - 1, 5)].focus();
        }
        updateOtpFull();
    });
});

function updateOtpFull() {
    let otp = '';
    otpInputs.forEach(input => otp += input.value);
    otpFull.value = otp;
    
    // Auto-submit when complete
    if (otp.length === 6) {
        document.getElementById('otpForm').requestSubmit();
    }
}

// Form submit
document.getElementById('otpForm').addEventListener('submit', function(e) {
    updateOtpFull();
    
    if (otpFull.value.length !== 6) {
        e.preventDefault();
        alert('Please enter complete 6-digit OTP');
        return;
    }
    
    const btn = this.querySelector('button[type="submit"]');
    btn.querySelector('.btn-text').style.display = 'none';
    btn.querySelector('.btn-loading').style.display = 'inline-flex';
    btn.disabled = true;
});

// Countdown timer
let countdown = 60;
const timerText = document.getElementById('timerText');
const countdownEl = document.getElementById('countdown');
const resendBtn = document.getElementById('resendBtn');

const timer = setInterval(() => {
    countdown--;
    countdownEl.textContent = countdown;
    
    if (countdown <= 0) {
        clearInterval(timer);
        timerText.style.display = 'none';
        resendBtn.style.display = 'inline-block';
    }
}, 1000);

// Resend OTP
resendBtn.addEventListener('click', async function() {
    this.disabled = true;
    this.textContent = 'Sending...';
    
    try {
        const response = await fetch('{% url "resend_otp" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        });
        
        const data = await response.json();
        
        if (data.ok) {
            // Reset timer
            countdown = data.cooldown || 60;
            countdownEl.textContent = countdown;
            timerText.style.display = 'block';
            resendBtn.style.display = 'none';
            
            const newTimer = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(newTimer);
                    timerText.style.display = 'none';
                    resendBtn.style.display = 'inline-block';
                    resendBtn.disabled = false;
                    resendBtn.innerHTML = 'Didn\'t receive code? <strong>Resend OTP</strong>';
                }
            }, 1000);
            
            alert('OTP sent successfully!');
        } else {
            alert(data.reason || 'Failed to resend OTP');
            resendBtn.disabled = false;
            resendBtn.innerHTML = 'Didn\'t receive code? <strong>Resend OTP</strong>';
        }
    } catch (err) {
        alert('Network error. Please try again.');
        resendBtn.disabled = false;
        resendBtn.innerHTML = 'Didn\'t receive code? <strong>Resend OTP</strong>';
    }
});
</script>
{% endblock %}
