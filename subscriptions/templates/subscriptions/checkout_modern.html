<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - {{ module.name }} | Hamsvic</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 380px;
        }
        .toast-notification {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
            backdrop-filter: blur(10px);
        }
        .toast-notification.hiding {
            animation: slideOut 0.3s ease-in forwards;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .toast-notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .toast-notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        .toast-notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        .toast-notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        .toast-icon {
            font-size: 1.25rem;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .toast-content {
            flex: 1;
        }
        .toast-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        .toast-message {
            font-size: 0.9rem;
            opacity: 0.95;
        }
        .toast-close {
            background: none;
            border: none;
            color: white;
            opacity: 0.7;
            cursor: pointer;
            padding: 0;
            margin-left: 12px;
            font-size: 1.25rem;
        }
        .toast-close:hover { opacity: 1; }
        .checkout-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            max-width: 480px;
            width: 100%;
            overflow: hidden;
        }
        .card-header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 2rem;
            text-align: center;
            color: white;
        }
        .card-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 0.25rem;
        }
        .card-header p {
            opacity: 0.8;
            margin: 0;
            font-size: 0.9rem;
        }
        .card-body { padding: 2rem; }
        .existing-sub {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .existing-sub i { color: #f59e0b; font-size: 1.25rem; }
        .existing-sub p { margin: 0; color: #92400e; font-size: 0.9rem; }
        .module-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-radius: 12px;
        }
        .module-icon {
            width: 50px;
            height: 50px;
            background: #6366f1;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        .module-details h3 { font-size: 1.1rem; font-weight: 600; margin: 0; color: #1f2937; }
        .module-details p { font-size: 0.85rem; color: #6b7280; margin: 0.25rem 0 0; }
        .order-summary {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .order-summary h4 {
            font-size: 0.85rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .order-item:last-child { border-bottom: none; }
        .order-item.total {
            border-top: 2px solid #e5e7eb;
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-weight: 700;
            font-size: 1.1rem;
        }
        .order-item .label { color: #4b5563; }
        .order-item .value { color: #1f2937; font-weight: 600; }
        .order-item.discount .value { color: #059669; }
        .order-item.total .value { color: #6366f1; font-size: 1.25rem; }
        .btn-pay {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-pay:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99,102,241,0.35);
        }
        .secure-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            color: #6b7280;
            font-size: 0.85rem;
        }
        .secure-badge i { color: #10b981; }
        .payment-methods {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        .payment-methods span {
            background: #f3f4f6;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #6b7280;
        }
        .back-link { text-align: center; margin-top: 1.5rem; }
        .back-link a {
            color: #64748b;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }
        .back-link a:hover { color: #1f2937; }
        .success-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .success-modal.show { display: flex; }
        .success-content {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            max-width: 400px;
            animation: successPop 0.3s ease;
        }
        @keyframes successPop {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
            color: white;
        }
        .success-content h2 { color: #1f2937; margin-bottom: 0.5rem; }
        .success-content p { color: #6b7280; margin-bottom: 1.5rem; }
    </style>
</head>
<body>
    <div class="checkout-card">
        <div class="card-header">
            <h1>Complete Your Purchase</h1>
            <p>Subscribe to {{ module.name }}</p>
        </div>
        <div class="card-body">
            {% if existing_subscription %}
            <div class="existing-sub">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <p>
                    You already have a {{ existing_subscription.get_status_display }} subscription for this module
                    (expires {{ existing_subscription.expires_at|date:"d M Y" }}). Purchasing now will extend your access.
                </p>
            </div>
            {% endif %}
            <div class="module-info">
                <div class="module-icon">
                    <i class="bi bi-{{ module.icon|default:'box' }}"></i>
                </div>
                <div class="module-details">
                    <h3>{{ module.name }}</h3>
                    <p>{{ pricing.get_duration_months_display }} subscription</p>
                </div>
            </div>
            <div class="order-summary">
                <h4>Order Summary</h4>
                <div class="order-item">
                    <span class="label">{{ module.name }} - {{ pricing.get_duration_months_display }}</span>
                    <span class="value">₹{{ pricing.base_price|floatformat:0 }}</span>
                </div>
                {% if pricing.discount_percent > 0 %}
                <div class="order-item discount">
                    <span class="label">Discount ({{ pricing.discount_percent|floatformat:0 }}%)</span>
                    <span class="value">- ₹{{ pricing.discount_amount|floatformat:0 }}</span>
                </div>
                {% endif %}
                <div class="order-item">
                    <span class="label">GST ({{ pricing.gst_percent|floatformat:0 }}%)</span>
                    <span class="value">₹{{ pricing.gst_amount|floatformat:0 }}</span>
                </div>
                <div class="order-item total">
                    <span class="label">Total</span>
                    <span class="value">₹{{ pricing.total_price|floatformat:0 }}</span>
                </div>
            </div>
            <button type="button" class="btn-pay" id="payBtn">
                <i class="bi bi-shield-check me-2"></i>
                Pay ₹{{ pricing.total_price|floatformat:0 }}
            </button>
            <div class="secure-badge">
                <i class="bi bi-lock-fill"></i>
                Secured by Razorpay
            </div>
            <div class="payment-methods">
                <span>UPI</span>
                <span>Cards</span>
                <span>NetBanking</span>
                <span>Wallets</span>
            </div>
            <div class="back-link">
                <a href="{% url 'module_access' module_code=module.code %}">
                    <i class="bi bi-arrow-left me-1"></i> Back to Plans
                </a>
            </div>
        </div>
    </div>
    <div class="success-modal" id="successModal">
        <div class="success-content">
            <div class="success-icon">
                <i class="bi bi-check-lg"></i>
            </div>
            <h2>Payment Successful!</h2>
            <p>Your subscription to {{ module.name }} is now active.</p>
            <a href="{% url 'dashboard' %}" class="btn btn-primary">
                <i class="bi bi-arrow-right me-2"></i>Go to Dashboard
            </a>
        </div>
    </div>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    <script>
    // Toast notification function
    function showToast(message, type = 'info', title = null, duration = 5000) {
        const container = document.getElementById('toastContainer');
        const icons = {
            success: 'bi-check-circle-fill',
            error: 'bi-x-circle-fill',
            warning: 'bi-exclamation-triangle-fill',
            info: 'bi-info-circle-fill'
        };
        const titles = {
            success: 'Success',
            error: 'Error',
            warning: 'Warning',
            info: 'Info'
        };
        
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        toast.innerHTML = `
            <i class="bi ${icons[type]} toast-icon"></i>
            <div class="toast-content">
                <div class="toast-title">${title || titles[type]}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.classList.add('hiding'); setTimeout(() => this.parentElement.remove(), 300);">
                <i class="bi bi-x"></i>
            </button>
        `;
        container.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentElement) {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }
        }, duration);
    }
    
    const payBtn = document.getElementById('payBtn');
    const successModal = document.getElementById('successModal');
    payBtn.addEventListener('click', async function() {
        payBtn.classList.add('loading');
        payBtn.disabled = true;
        try {
            const response = await fetch("{% url 'create_order' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `pricing_id={{ pricing.id }}`
            });
            const data = await response.json();
            if (!data.ok) {
                showToast(data.reason || 'Failed to create order', 'error', 'Order Failed');
                payBtn.classList.remove('loading');
                payBtn.disabled = false;
                return;
            }
            
            // DEV MODE: If order_id starts with 'order_mock_', skip Razorpay and verify directly
            if (data.order_id && data.order_id.startsWith('order_mock_')) {
                console.log('DEV MODE: Simulating payment for mock order');
                const verifyResponse = await fetch("{% url 'verify_payment' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        razorpay_order_id: data.order_id,
                        razorpay_payment_id: 'pay_mock_' + Date.now(),
                        razorpay_signature: 'mock_signature_dev_mode'
                    })
                });
                const verifyData = await verifyResponse.json();
                if (verifyData.ok) {
                    successModal.classList.add('show');
                } else {
                    showToast(verifyData.reason || 'Payment verification failed', 'error', 'Verification Failed');
                }
                payBtn.classList.remove('loading');
                payBtn.disabled = false;
                return;
            }
            
            // PRODUCTION: Use Razorpay checkout
            const options = {
                key: data.key,
                amount: data.amount,
                currency: data.currency,
                order_id: data.order_id,
                name: 'Hamsvic',
                description: '{{ module.name }} - {{ pricing.get_duration_months_display }}',
                handler: async function(response) {
                    const verifyResponse = await fetch("{% url 'verify_payment' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_signature: response.razorpay_signature
                        })
                    });
                    const verifyData = await verifyResponse.json();
                    if (verifyData.ok) {
                        successModal.classList.add('show');
                    } else {
                        showToast(verifyData.reason || 'Payment verification failed', 'error', 'Verification Failed');
                    }
                    payBtn.classList.remove('loading');
                    payBtn.disabled = false;
                },
                prefill: {
                    name: '{{ user.get_full_name|default:user.username }}',
                    email: '{{ user.email }}',
                },
                theme: { color: '#6366f1' },
                modal: {
                    ondismiss: function() {
                        payBtn.classList.remove('loading');
                        payBtn.disabled = false;
                    }
                }
            };
            const rzp = new Razorpay(options);
            rzp.open();
        } catch (error) {
            console.error('Error:', error);
            showToast('Something went wrong. Please try again.', 'error', 'Error');
            payBtn.classList.remove('loading');
            payBtn.disabled = false;
        }
    });
    </script>
</body>
</html>
